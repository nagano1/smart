name: ðŸ‘½ Windows binary using Clang/LLVM 

on:
  push:
  pull_request:
  schedule:
    - cron: '15 3 1 11 *' # minute hour day month monday

jobs:
  mybuild:
    name: ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      matrix:
        config:
          - {
              # 64bit
              name: 64bit,
              os: windows-latest,
              main: "main.exe",
              hello: "hello.exe",
              flag: "",
              sudo: ' ',
            }
          - {
              # 32bit
              name: 32bit,
              os: windows-latest,
              main: "main32.exe",
              hello: "hello32.exe",
              flag: "-m32",
              sudo: ' ',
            }
          
    steps:
      - uses: actions/checkout@v3

      - name: enable problem matcher
        run: |
          echo "::add-matcher::.github/problem_matcher.json"

      - name: do build
        shell: bash
        run: |
          npm --version
          npm i
          node_modules/.bin/gulp show --github_actions ${{ matrix.config.flag }}
          echo wow
          ./wow.exe

      

      - name: Emulating output binary from doorlang - msys64/mingw clang++/llvm compile msys64/mingw on Windows
        shell: bash
        run: |
          dir C:\\msys64\\mingw32\\bin

          #clang.exe --version
          #dir $(pwd)/llvm/bin
          
          cd llvm_ir_test
          clang++ ${{ matrix.config.flag }} -S main.cpp 
          clang++ ${{ matrix.config.flag }} -S lib.cpp
          #llc main.ll
          #llc lib.ll
          

          dir

          clang++.exe ${{ matrix.config.flag }} -static -lpthread main.s lib.s -o hello.exe;
          # clang++ ${{ matrix.config.flag }} -mwindows main.s lib.s -o hello.exe;
          ls -al;
          #./hello.exe;

         
      - name: Copy artifact
        run: |
          cd build;
          mkdir -p deb;

      - name: Copy artifact for windows
        run: |
          copy wow.exe ./build/deb/${{ matrix.config.main }}

          cd llvm_ir_test;
          copy hello.exe ../build/deb/${{ matrix.config.hello }}
      
      - uses: actions/upload-artifact@v3
        with:
          name: win-llvm-_${{ github.sha }}
          path: build/deb





















          
      # - name: Install clang (Windows)
      #   if: matrix.config.os == 'windows-latest'
      #   shell: bash
      #   run: |
      #     curl -fsSLO https://github.com/llvm/llvm-project/releases/download/llvmorg-10.0.0/LLVM-10.0.0-win64.exe
      #     7z x LLVM-10.0.0-win64.exe -y -o"llvm"
      #     #echo "$(pwd)/llvm/bin" >> $GITHUB_PATH
      #     #echo "WASM_AR=$(pwd)/llvm/bin/llvm-ar.exe" >> $GITHUB_ENV

      # - name: Install llvm-nm (Windows)
      #   if: matrix.config.os == 'windows-latest'
      #   shell: bash
      #   run: |
      #     rustup update stable
      #     rustup default stable
      #     rustup component add llvm-tools-preview
      #     echo "$(rustc --print sysroot|sed 's|C:|/c|'|sed 's|\\|/|g')/lib/rustlib/x86_64-pc-windows-msvc/bin/llvm-nm.exe"
      #     ls -al "$(rustc --print sysroot|sed 's|C:|/c|'|sed 's|\\|/|g')/lib/rustlib/x86_64-pc-windows-msvc/bin/"

      # - name: Install llvm-nm (Windows)
      #   shell: bash
      #   run: |
      #     rustup update stable
      #     rustup default stable
      #     rustup component add llvm-tools-preview
      #     echo "::set-env name=WASM_NM::$(rustc --print sysroot|sed 's|C:|/c|'|sed 's|\\|/|g')/lib/rustlib/x86_64-pc-windows-msvc/bin/llvm-nm.exe"
      #   if: matrix.config.os == 'windows-latest'








        #       addpath: 'C:\\msys64\mingw64\bin',
        # addpath_old: 'echo "::add-path::C:\msys64\mingw32\bin"',
        #       addpath: 'C:\\msys64\mingw32\bin',
        #   # echo "${{ matrix.config.addpath }}" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8